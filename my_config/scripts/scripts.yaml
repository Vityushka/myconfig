  ha_released_update:
    alias: HA Released version update from server
    sequence:
      service: homeassistant.update_entity
      entity_id: sensor.ha_latest_version

  speedtest_manual:
    alias: Speedtest
    sequence:
      - service: speedtestdotnet.speedtest

  purge_db:
    alias: Purge Main DB
    sequence:
      - service: recorder.purge
        data:
          keep_days: 1
          repack: true

  noop:
    alias: Dummy
    sequence:
      - delay:
          seconds: 0.1 
      
  water_off:
    alias: Turn Water Off
    sequence:
      - service: switch.turn_on
        entity_id: switch.0x00158d000366815b_switch_l1 #switch.plug_158d00020d8679
      - delay: '00:00:25'
      - service: switch.turn_off
        entity_id: switch.0x00158d000366815b_switch_l1 #switch.plug_158d00020d8679

  water_on:
    alias: Turn Water On
    sequence:
      - service: switch.turn_on
        entity_id: switch.0x00158d000366815b_switch_l2 #switch.plug_158d0001f54f90
      - delay: '00:00:25'
      - service: switch.turn_off
        entity_id: switch.0x00158d000366815b_switch_l2 #switch.plug_158d0001f54f90

  battery_level_check:
    alias: Battery Level Check
    sequence:
      - service: script.turn_on
        data_template:
          entity_id: >
              {% if states | selectattr('attributes.battery_level', 'defined') | selectattr('attributes.battery_level','<', states('input_number.battery_low_level')|int ) | list | count >= 1 %}
                script.battery_level_low
              {% else %}
                script.battery_level_ok
              {% endif%}

  battery_level_low:
    alias: Battery Level Low
    sequence:
      - service: notify.telegram
        data_template:
          message: >
            {%- set low_batteries = states | selectattr('attributes.battery_level', 'defined') | selectattr('attributes.battery_level','<', states('input_number.battery_low_level')|int ) | map(attribute='name') | list | join(', ') -%}
            {{"\U0001f6a8"}} Низкий заряд батарей: {{ low_batteries }}

  battery_level_ok:
    alias: Battery Level Ok
    sequence:
      - service: notify.telegram
        data:
          message: "\U0001f50b Батарей с уровнем заряда ниже {{states('input_number.battery_low_level')|int}}% не найдено!"

  tts_test:
    alias: Test TTS
    sequence:
      - service: media_player.volume_set
        data_template:
          entity_id: media_player.{{states('input_select.main_audio_out')|lower}}
          volume_level: '{{states("input_number.main_volume")|float}}'
      - service: tts.yandextts_say
        data_template:
          entity_id: media_player.{{states('input_select.main_audio_out')|lower}}
          message: "Проверка звука!"
          
  zigbee2mqtt_test:
    alias: Zigbee2Mqtt Devices Responce Test
    sequence:
      - service: notify.telegram
        data_template:
          message: >
            {% set time_limit = as_timestamp(now())-4*60*60 %}
            {% set missing = states | selectattr('attributes.last_seen', 'defined') | selectattr('attributes.linkquality', 'defined')| selectattr('attributes.last_seen','<', time_limit*1000 ) | map(attribute='name') | list | join(', ') %}
            {% set missing_count = states | selectattr('attributes.last_seen', 'defined') | selectattr('attributes.linkquality', 'defined')| selectattr('attributes.last_seen','<', time_limit*1000 ) | map(attribute='name') | list | count %}
            
            {% if missing_count >0 %}{{"\U0001f4f6"}} No Response for last 4hrs from: {{ missing }}{%else%}{{"\U00002705"}}All devices online!{%endif%}