# #####################################################################################
#
# HALL BIG
#
# #####################################################################################
# Hall Big - Auto Night Light On
# ##################################
- alias: hall_big_auto_night_light_on
  initial_state: 'on'
  trigger:
    platform: event
    event_type: xiaomi_aqara.motion
    event_data:
      entity_id: binary_sensor.motion_sensor_158d0001e05856
    #from: 'off'
    #to: 'on'
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: binary_sensor.tod_night
        state: 'on'
      - condition: state
        entity_id: light.led_strip_hb
        state: 'off'
  action:
    - service: light.turn_on
      entity_id: light.led_strip_hb
      data:
        brightness_pct: 2
        kelvin: 3000
    - delay: '00:00:30'
    - service: light.turn_off
      entity_id: light.led_strip_hb

# ##################################
# Hall Big - Auto Light On
# ##################################
- alias: hall_big_auto_light_on
  initial_state: 'on'
  trigger:
    # - platform: event
    #   event_type: xiaomi_aqara.motion
    #   event_data:
    #     entity_id: binary_sensor.motion_hb #.motion_sensor_158d0001e05856, binary_sensor.motion_sensor_158d0002b482e9
    # - platform: event
    #   event_type: xiaomi_aqara.motion
    #   event_data:
    #     entity_id: binary_sensor.motion_sensor_158d0002b482e9
     - platform: state
       entity_id: binary_sensor.motion_hb #.motion_sensor_158d0001e05856
       from: 'off'
       to: 'on'
    # - platform: state
    #   entity_id: binary_sensor.motion_sensor_158d0002b482e9
    #   from: 'off'
    #   to: 'on'
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: binary_sensor.tod_day
        state: 'on'
      - condition: state
        entity_id: light.led_strip_hb
        state: 'off'
  action:
    - service: light.turn_on
      entity_id: light.led_strip_hb
      data_template:
        brightness_pct: 100
        kelvin: 6500

# ##################################
# Hall Big - Auto Night Light Off 60s without movements
# ##################################
- alias: hall_big_night_auto_off_60s
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: binary_sensor.motion_sensor_158d0001e05856
    to: 'off'
    for:
      seconds: 30
  condition:
    - condition: state
      entity_id: binary_sensor.tod_night
      state: 'on'
  action:
    - service: light.turn_off
      entity_id: light.led_strip_hb
# ##################################
# Hall Big - Auto Light Off 1m without movements
# ##################################
- alias: hall_big_auto_off_60s
  initial_state: 'on'
  trigger:
    #- platform: state
    #  entity_id: binary_sensor.motion_sensor_158d0001e05856
    #  to: 'off'
    #  for:
    #    seconds: 1
    #- platform: state
    #  entity_id: binary_sensor.motion_sensor_158d0002b482e9
    #  to: 'off'
    #  for:
    #    seconds: 1
    - platform: state
      entity_id: binary_sensor.motion_hb
      to: 'off'
      from: 'on'
      for:
        minutes: 1
  condition:
    - condition: state
      entity_id: binary_sensor.tod_day
      state: 'on'
  action:
    - service: light.turn_off
      entity_id: light.led_strip_hb
      
# ##################################
# Hall Big - Auto Light On when door opened
# ##################################
- alias: hall_big_main_door_open
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: binary_sensor.door_window_sensor_158d0001e5d6be
    from: 'off'
    to: 'on'
#  condition:
#    - condition: state
#      entity_id: light.led_strip_hb
#      state: 'off'
  action:
    - service: input_number.set_value
      data_template:
        entity_id: input_number.main_door_open
        value: '{{as_timestamp (now())|int}}'
    - service: timer.cancel
      entity_id: timer.timer_open_door_hb
    - service: timer.start
      entity_id: timer.timer_open_door_hb
    - service: light.turn_on
      entity_id: light.led_strip_hb
      data_template:
        brightness_pct: >
          {%- if is_state('binary_sensor.tod_night','on') -%}
          2
          {%- else -%}
          100
          {% endif %}
        kelvin: >
          {%- if is_state('binary_sensor.tod_night','on') -%}
          3000
          {%- else -%}
          6500
          {% endif %}
    - service: counter.increment
      entity_id: counter.main_door_hb
    - service: notify.telegram
      data_template:
        message: "\U0001f6aa Внимание! Входная дверь открыта! ({{states('sensor.time')}} {{states('sensor.date')}}, {{ states('counter.main_door_hb') }})"
    - service: notify.telegram_cam
      data_template:
        message: "\U0001f6aa Внимание! Входная дверь открыта! ({{states('sensor.time')}} {{states('sensor.date')}}, {{ states('counter.main_door_hb') }})"
    - delay: '00:00:09'
    - service: script.turn_on
      entity_id: script.open_door_photo

# ##################################
# Hall Big - Main Door Closed
# ##################################
- alias: hall_big_main_door_closed
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: binary_sensor.door_window_sensor_158d0001e5d6be
    from: 'on'
    to: 'off'
  action:
    - service: camera.snapshot
      data:
        entity_id: camera.pinhole
        filename: "/config/www/cam_captures/door_close2.jpg"
    - service: notify.telegram
      data:
        title: Doorbell photo
        message: "\U0001f514 Входная дверь закрыта!"
        data:
          photo:
          - file: /config/www/cam_captures/door_close2.jpg
            #caption: "\U0001F6AA Входная дверь закрыта {{ now().strftime('%H:%M') }}, была открыта {{ (as_timestamp(now())| round(0) - as_timestamp(states.timer.timer_open_door_hb.last_changed)| int)| timestamp_custom('%H:%M:%S',0) }}"
            caption: "\U0001F6AA Входная дверь закрыта {{ now().strftime('%H:%M') }}, была открыта {{(as_timestamp(now())|round(0)-states.input_number.main_door_open.state|int)|int | timestamp_custom('%H:%M:%S',0)}} \ {{ (as_timestamp(now())| round(0) - as_timestamp(states.timer.timer_open_door_hb.last_changed)| int)| timestamp_custom('%H:%M:%S',0) }}"
            
    - service: timer.cancel
      entity_id: timer.timer_open_door_hb

# ##################################
# Hall Big - Main door not closed for 3 minutes
# ##################################
- alias: hall_big_main_door_not_closed_3m
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: binary_sensor.door_window_sensor_158d0001e5d6be
    from: 'off'
    to: 'on'
    for:
     minutes: 3
  action:
    - service_template: >
        {% if is_state('binary_sensor.tod_day','on') %} script.main_door_not_closed_tts
        {%else%} script.noop
        {%endif%}
    - service: notify.telegram
      data_template:
        message: "\U0001F441 Внимание! Входная дверь НЕ закрыта!"
    - service: script.turn_on
      entity_id: script.open_door_photo
          
# ##################################
# Hall Big - Auto Light On when door opened_night
# ##################################
# - alias: hall_big_main_door_open_night
#   initial_state: 'on'
#   trigger:
#     platform: state
#     entity_id: binary_sensor.door_window_sensor_158d0001e5d6be
#     from: 'off'
#     to: 'on'
#   condition:
#     condition: time
#     after: '21:00:00'
#     before: '07:00:00'
#   action:
#     - service: timer.cancel
#       entity_id: timer.timer_open_door_hb
#     - service: timer.start
#       entity_id: timer.timer_open_door_hb
#     - service: light.turn_on
#       entity_id: light.led_strip_hb
#       data_template:
#         brightness_pct: 1
#         # color_temp: 254
#         kelvin: 3000
#     - service: counter.increment
#       entity_id: counter.main_door_hb
#     - service: notify.telegram
#       data_template:
#         message: "\U0001f6aa Внимание! Входная дверь открыта! {{states('sensor.time')}} {{states('sensor.date')}}, {{ states('counter.main_door_hb') }}"
#     - service: notify.telegram_cam
#       data_template:
#         message: "\U0001f6aa Внимание! Входная дверь открыта! {{states('sensor.time')}} {{states('sensor.date')}}, {{ states('counter.main_door_hb') }}"
#     - delay: 00:00:10
#     - service: script.turn_on
#       entity_id: script.open_door_photo
#     - delay: 00:01:00
#     - service: light.turn_off
#       entity_id: light.led_strip_hb

# ##################################
# Hall Big - Auto Light On Entrance
# ##################################
- alias: hall_big_auto_light_on_entrance
  initial_state: 'on'
  trigger:
    - platform: event
      event_type: xiaomi_aqara.motion
      event_data:
        entity_id: binary_sensor.motion_sensor_158d0001e05856
  condition:
    condition: and
    conditions:
      - condition: numeric_state
        entity_id: sensor.illuminnation_158d0001e05856
        below: 10
      - condition: state
        entity_id: binary_sensor.tod_day
        state: 'on'
  action:
    - service: switch.turn_on
      entity_id: switch.wall_switch_left_158d000223921b


# ##################################
# Hall Big - Auto Light On Fridge
# ##################################
- alias: hall_big_auto_light_on_fridge
  initial_state: 'on'
  trigger:
    - platform: event
      event_type: xiaomi_aqara.motion
      event_data:
        entity_id: binary_sensor.motion_sensor_158d0002b482e9
  condition:
    condition: and
    conditions:
      - condition: numeric_state
        entity_id: sensor.illuminnation_158d0002b482e9
        below: 10
      - condition: state
        entity_id: binary_sensor.tod_day
        state: 'on'
  action:
    - service: switch.turn_on
      entity_id: switch.wall_switch_right_158d000253f04a
      
# ##################################
# Hall big - Timer start on light on
# ################################## 
- alias: hall_big_timer_on
  initial_state: true
  trigger:
  - platform: state
    entity_id: switch.wall_switch_left_158d000223921b
    to: 'on'
    from: 'off'
  - platform: state
    entity_id: switch.wall_switch_right_158d000253f04a
    to: 'on'
    from: 'off'
  action:
  - service: timer.cancel
    entity_id: timer.timer_hb
  - service: timer.start
    entity_id: timer.timer_hb
    
# ##################################
# Hall big - Timer off
# ################################## 
- alias: hall_big_timer_off
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id: switch.wall_switch_left_158d000223921b
    to: 'off'
    from: 'on'
  - platform: state
    entity_id: switch.wall_switch_right_158d000253f04a
    to: 'off'
    from: 'on'
  action:
  - service: timer.cancel
    entity_id: timer.timer_hb

# ##################################
# Hall big - Auto Light Off 10m without movements
# ##################################
- alias: hall_big_auto_off_10m
  initial_state: 'on'
  trigger:
  - platform: event
    event_type: timer.finished
    event_data:
      entity_id: timer.timer_hb
  action:
    - service: switch.turn_off
      entity_id: switch.wall_switch_left_158d000223921b, switch.wall_switch_right_158d000253f04a

# ##################################
# Hall big - Timer restart with movement
# ################################## 
- alias: hall_big_timer_restart
  initial_state: 'on'
  trigger:
  - platform: event
    event_type: xiaomi_aqara.motion
    event_data:
      entity_id: binary_sensor.motion_sensor_158d0001e05856
  - platform: event
    event_type: xiaomi_aqara.motion
    event_data:
      entity_id: binary_sensor.motion_sensor_158d0002b482e9
  condition:
    condition: or
    conditions:
      - condition: state
        entity_id: switch.wall_switch_left_158d000223921b
        state: 'on'
      - condition: state
        entity_id: switch.wall_switch_right_158d000253f04a
        state: 'on'
  action:
  - service: timer.cancel
    entity_id: timer.timer_hb
  - service: timer.start
    entity_id: timer.timer_hb

# ##################################
# Hall Big - Entrance light On from Fridge
# ##################################
- alias: hall_big_entrance_light_on_from_fridge
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: switch.wall_switch_left_158d000253f04a
  action:
    - service: switch.toggle
      entity_id: switch.wall_switch_left_158d000223921b

# ##################################
# Hall Big - Fridge light On from Entrance
# ##################################
- alias: hall_big_fridge_light_on_from_entrance
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: switch.wall_switch_right_158d000223921b
  action:
    - service: switch.toggle
      entity_id: switch.wall_switch_right_158d000253f04a

# ##################################
# Hall Big - Main power turned off
# ##################################
- alias: hall_big_main_power_turned_off
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: switch.wall_plug_158d000230fc52
    to: 'off'
    from: 'on'
  action:
    - service: notify.telegram
      data_template:
        message: "\U0001f50c Внимание! Главная розетка отключена! Запущен UPS"

# ##################################
# Hall Big - Main plug pulled out
# ##################################
- alias: hall_big_main_plug_pulled_out
  initial_state: 'on'
  trigger:
    platform: numeric_state
    entity_id: sensor.fridge_hb
    below: 10
  action:
    - service: notify.telegram
      data_template:
        message: "\U0001f50c Внимание! Нагрузка в главной розетке упала! Проверь кабель!"

# ##################################
# Hall Big - Main power - over-power
# ##################################
- alias: hall_big_main_power_overpower
  initial_state: 'on'
  trigger:
    platform: numeric_state
    entity_id: sensor.fridge_hb
    above: 1700 
  action:
    - service: notify.telegram
      data_template:
        message: "\U0001f50c Внимание! Перегрузка главной розетки! Отключите лишние потребители!"

# ##################################
# Hall Big - UPS - OB
# ##################################
- alias: hall_big_ups_ob
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: sensor.ippon_hb_status_data
    to: 'OB'
  action:
    - service: notify.telegram
      data_template:
        message: "\U0001f50b Внимание! Запущен UPS!"
    - service: notify.mobile_app_iphone_8_dtsymbal
      data:
        title: "Внимание!"
        message: "Запущен UPS"

# ##################################
# Hall Big - UPS - LB
# ##################################
- alias: hall_big_ups_lb
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: sensor.ippon_hb_status_data
    to: 'LB'
  action:
    - service: notify.telegram
      data_template:
        message: "\U0001f6a8 Внимание! Заряд батареи критический! Завершение работы!"
    - service: notify.mobile_app_iphone_8_dtsymbal
      data:
        title: "Внимание!"
        message: "UPS полностью разряжен! Зывершаем работу!"
    - service: hassio.host_shutdown

# ##################################
# Hall Big - UPS - OL
# ##################################
- alias: hall_big_ups_ol
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: sensor.ippon_hb_status_data
    to: 'OL'
  action:
    - service: notify.telegram
      data_template:
        message: "\U0001f50b Питание восстановлено! Начинаем заряд батареи!"

# ##################################
# Hall Big - UPS - Unknown
# ##################################
- alias: hall_big_ups_unknown
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: sensor.ippon_hb_status_data
    to: "unknown"
  action:
    - service: notify.telegram
      data_template:
        message: "\U0001f6a8 Внимание! Связь с UPS потеряна!"
    #- service: notify.mobile_app_iphone_8_dtsymbal
    #  data:
    #    title: "Внимание!"
    #    message: "Связь с UPS потеряна!"

# ##################################
# Hall Big - UPS - Unknown to OL
# ##################################
- alias: hall_big_ups_unknown_to_ol
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: sensor.ippon_hb_status_data
    from: "unknown"
    to: "OL"
  action:
    - service: notify.telegram
      data_template:
        message: "\U0001f50b Связь с UPS восстановлена!"

# ##################################
# Hall Big - Main power turned on
# ##################################
- alias: hall_big_main_power_turned_on
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: switch.wall_plug_158d000230fc52
    to: 'on'
  action:
    - service: notify.telegram
      data_template:
        message: "\U0001f50c Электроснабжение восстановлено! Начинаем зарядку UPS!"
        
# ##################################
# Hall Big - left home
# ##################################
- alias: hall_big_left_home
  initial_state: 'on'
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.switch_158d00023d3206
      click_type: single
  action:
    - service: media_player.volume_set
      data_template:
        entity_id: media_player.mpd
        volume_level: '0.3'
    - service: notify.telegram
      data_template:
        message: "\U0001f4a1 Выключаем освещение"
    - service: tts.yandextts_say
      entity_id: media_player.mpd
      data_template:
        message: 'Выключ+аю освещ+ение!'
    - delay: '00:00:03'
    - service: script.turn_on
      entity_id: script.lights_off
    - service: notify.telegram
      data_template:
        message: "\U0001f4a1 Освещение выключено"
    - service: tts.yandextts_say
      entity_id: media_player.mpd
      data_template:
        message: 'Освещ+ение в+ыключено! Всег+о хор+ошего!'

# ##################################
# Hall Big - Sasha Button - Weather fcst - long
# ##################################
- alias: hall_big_weather_fcst
  initial_state: 'on'
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.switch_158d0002fa99a8
      click_type: long_click_press
  action:
    - service: script.weather_tts
      data_template:
        entity_id: media_player.mpd
        volume_level: '0.3'
        
# ##################################
# Hall Big - Fridge open for more than 
# ##################################
- alias: hall_big_fridge_not_closed_5m
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: binary_sensor.door_window_sensor_158d000253722b
    #from: 'off'
    to: 'on'
    for:
     minutes: 5
  action:
    - service: media_player.volume_set
      data_template:
        entity_id: media_player.mpd
        volume_level: '0.3'
    - service: tts.yandextts_say
      entity_id: media_player.mpd
      data_template:
        message: 'Вним+ание! Холод+ильник н+е закр+ыт!'
    - service: notify.telegram
      data_template:
        message: "\U0001F441 Внимание! Холодильник не закрыт!"
            
# ##################################
# Hall Big - Freezer open for more than 
# ##################################
- alias: hall_big_freezer_not_closed_5m
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: binary_sensor.door_window_sensor_158d000252acba
    to: 'on'
    for:
     minutes: 5
  action:
    - service: media_player.volume_set
      data_template:
        entity_id: media_player.mpd
        volume_level: '0.3'
    - service: tts.yandextts_say
      entity_id: media_player.mpd
      data_template:
        message: 'Вним+ание! Мороз+ильник н+е закр+ыт!'
    - service: notify.telegram
      data_template:
        message: "\U0001F441 Внимание! Морозильник не закрыт!"
        
# ##################################
# Hall Big - LED Strip Reset 
# ##################################
- alias: hall_big_led_strip_reset
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: light.led_strip_hb
      to: 'unavailable'
      for: '00:05:00'
    # - platform: state
    #   entity_id: light.led_strip_hb
    #   from: 'unavailable'
  # condition:
  #   condition: state
  #   entity_id: binary_sensor.led_strip_hb
  #   state: 'off'
  action:
    - service: script.turn_on
      entity_id: script.led_strip_restart
    - service: notify.telegram
      data_template:
        message: "LED Strip HB restart done!"


# ##################################
# Hall Big - LED Strip Power Switch Turn On
# ##################################
- alias: hall_big_led_strip_switch_on
  initial_state: 'on'
  trigger:
    platform: state
    entity_id: switch.wall_plug_158d00023e5812
    to: 'off'
    for: '00:00:03'
  action:
    - service: switch.turn_on
      entity_id: switch.wall_plug_158d00023e5812

      
# ##################################
# Hall Big - Main Door Bottom Lock
# ##################################
- alias: hall_big_bottom_lock
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: binary_sensor.door_window_sensor_158d0002a1a4b2
      from: 'on'
      to: 'off'
    - platform: state
      entity_id: binary_sensor.door_window_sensor_158d0002a1a4b2
      from: 'off'
      to: 'on'
  action:
    - service: script.turn_on
      data_template:
        entity_id: >
          script.bottom_lock_yellow_led_blink_{% if is_state('binary_sensor.door_window_sensor_158d0002a1a4b2','on') %}off{% else %}on{% endif %}
    - service: notify.telegram
      data_template:
        message: "{% if is_state('binary_sensor.door_window_sensor_158d0002a1a4b2','on') %}\U0001F513\U0001F53D Нижний замок открыт!{% else %}\U0001F512\U0001F53D Нижний замок закрыт!{% endif %}"
    - service: media_player.volume_set
      data_template:
        entity_id: media_player.mpd
        volume_level: '0.3'
    - service: script.turn_on
      data_template:
        entity_id: >
          {% if is_state('binary_sensor.tod_day','on') %}
            script.bottom_lock_tts
          {% endif %}

# ##################################
# Hall Big - Main Door Top Lock
# ##################################
- alias: hall_big_top_lock
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: binary_sensor.door_window_sensor_158d0002b7c2c8
      from: 'on'
      to: 'off'
    - platform: state
      entity_id: binary_sensor.door_window_sensor_158d0002b7c2c8
      from: 'off'
      to: 'on'
  action:
    - service: notify.telegram
      data_template:
        message: "{% if is_state('binary_sensor.door_window_sensor_158d0002b7c2c8','on') %}\U0001F513\U0001F53C Верхний замок открыт!{% else %}\U0001F512\U0001F53C Верхний замок закрыт!{% endif %}"
    - service: media_player.volume_set
      data_template:
        entity_id: media_player.mpd
        volume_level: '0.3'
    - service_template: >
        {% if is_state('binary_sensor.tod_day','on') %} script.top_lock_tts
        {% else%} script.noop
        {% endif %}
    - service_template: "light.turn_{% if is_state('binary_sensor.door_window_sensor_158d0002b7c2c8','on') %}on{% else %}off{% endif %}"
      data:
        entity_id: light.esp32_domofon_yellow_led
    - service_template: "light.turn_{% if is_state('binary_sensor.door_window_sensor_158d0002b7c2c8','on') %}off{% else %}on{% endif %}"
      data:
        entity_id: light.esp32_domofon_yellow_led
        
# ##################################
# Hall Big - Domofon Incoming Call
# ##################################
- alias: hall_big_domofon_incoming_call
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: binary_sensor.esp32_domofon_incomingcall
      to: 'on'
  action:
    #- service: automation.turn_off
    #  entity_id: automation.hall_big_domofon_incoming_call
    - service: camera.snapshot
      data:
        entity_id: camera.uvc_g3_flex_window
        filename: "/config/www/cam_captures/domofon.jpg"
    - service: script.turn_on
      entity_id: script.domofon_script
    - service: notify.telegram
      data:
        title: "{{now().strftime('%H:%M %d-%m-%Y')}}"
        message: "{{now().strftime('%H:%M %d-%m-%Y')}}"
        data:
          photo:
          - file: "/config/www/cam_captures/window.jpg"
            caption: "Звонок в домофон {{now().strftime('%H:%M %d-%m-%Y')}}"
    - delay: '00:00:30'
    - service: automation.turn_on
      entity_id: automation.hall_big_domofon_incoming_call
    - delay: '00:15:00'
    - service: script.turn_on
      entity_id: script.domofon_check

# ##################################
# Hall Big - Domofon Auto Open On Arrival
# ##################################
- alias: hall_big_domofon_auto_open_on_arrival
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: person.dima
      to: 'home'
    - platform: state
      entity_id: person.sandra
      to: 'home'
    - platform: state
      entity_id: person.vova
      to: 'home'
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: input_boolean.domofon_auto_open_once
        state: 'off'
      - condition: state
        entity_id: input_boolean.domofon_auto_open
        state: 'off'
      - condition: template
        value_template: '{{ trigger.from_state.state != trigger.to_state.state }}'
  action:
    - service: notify.telegram
      data_template:
        message: >
          {% if trigger.from_state.attributes.friendly_name == "Dima" %} {{"\U0001F9D4"}} Дима прибыл домой!
          {% elif trigger.from_state.attributes.friendly_name == "Sandra" %} {{"\U0001F467"}} Саша прибыла домой!
          {% elif trigger.from_state.attributes.friendly_name == "Vova" %} {{"\U0001F471"}} Вова прибыл домой!
          {%endif%}
    - service_template: >
        {% if trigger.from_state.attributes.friendly_name != "Babayka"%} notify.telegram_{{ trigger.from_state.attributes.friendly_name|lower }}
        {%else%} script.noop
        {%endif%}
      data_template:
        message: "\U0001F4DE Домофон: Автооткрытие включено на 15мин! {% if is_state('binary_sensor.bottom_lock','off') or is_state('binary_sensor.upper_lock','off') %}Закрыт{%if is_state('binary_sensor.bottom_lock','off') %} нижний{%endif%}{%if is_state('binary_sensor.upper_lock','off')%} и верхний{%endif%} замок{%endif%}"
          
    - service: script.turn_on
      entity_id: script.domofon_mute_toggle
    - service: script.turn_on
      entity_id: script.domofon_auto_open_once_toggle
    - delay: '00:15:00'
    - service: script.turn_on
      entity_id: script.domofon_check

# ##################################
# Hall Big - Door close
# ##################################
- alias: hall_big_door_close
  initial_state: 'off'
  trigger:
    - platform: state
      entity_id: binary_sensor.door_window_sensor_158d0001e5d6be
      from: 'on'
      to: 'off'
  action:
    #- service: camera.snapshot
    #  data:
    #    entity_id: camera.door_hb
    #    filename: "/config/www/cam_captures/door_close.jpg"
    - service: camera.snapshot
      data:
        entity_id: camera.pinhole
        filename: "/config/www/cam_captures/door_close2.jpg"
    - service: notify.telegram
      data:
        title: Doorbell photo
        message: "\U0001f514 Входная дверь закрыта!"
        data:
          photo:
          #- file: /config/www/cam_captures/door_close.jpg
          #  caption: "\U0001f514 Входная дверь закрыта!"
          - file: /config/www/cam_captures/door_close2.jpg
            caption: "\U0001f514 Входная дверь закрыта!"
            
# ##################################
# Hall Big - Motion Outside
# ##################################
- alias: hall_big_motion_outside_esp32
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: binary_sensor.esp32_domofon_motion
      from: 'off'
      to: 'on'
  action:
    - service: camera.snapshot
      data:
        entity_id: camera.door_hb
        filename: "/config/www/cam_captures/outside.jpg"
    - delay: '00:00:03'
    - service: notify.telegram_cam
      data:
        title: "{{states('sensor.time')}} {{states('sensor.date')}}"
        message: "ESP32 - Движение за дверью! {{states('sensor.time')}} {{states('sensor.date')}} "
        data:
          photo:
          - file: /config/www/cam_captures/outside.jpg
            caption: "ESP32 - Движение за дверью! {{states('sensor.time')}} {{states('sensor.date')}} "


# ##################################
# Hall Big - Motion Outside
# ##################################
- alias: hall_big_motion_outside_motioneye
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: binary_sensor.pinhole_camera_motion
      from: 'off'
      to: 'on'
  action:
    - delay: '00:00:04'
    - service: camera.snapshot
      data:
        entity_id: camera.door_hb
        filename: "/config/www/cam_captures/outside.jpg"
    - delay: '00:00:03'
    - service: notify.telegram_cam
      data:
        title: "{{states('sensor.time')}} {{states('sensor.date')}}"
        message: "Движение за дверью! {{states('sensor.time')}} {{states('sensor.date')}} "
        data:
          photo:
          - file: /config/www/cam_captures/outside.jpg
            caption: "MotionEye - Движение за дверью! {{states('sensor.time')}} {{states('sensor.date')}} "

# ##################################
# Hall Big - Domofon auto off on door open\close
# ##################################
- alias: hall_big_domofon_off_on_door open_close
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: binary_sensor.door_window_sensor_158d0001e5d6be
      from: 'on'
      to: 'off'
  condition:
    - condition: state
      entity_id: input_boolean.domofon_auto_open_once
      state: 'on'
    - condition: state
      entity_id: input_boolean.domofon_mute
      state: 'on'
  action:
    - service: script.turn_on
      entity_id: script.domofon_check

# ##################################
# Hall Big - Doorbell
# ##################################
- alias: hall_big_doorbell
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: binary_sensor.doorbell
      from: 'off'
      to: 'on'
  action:
    - service: camera.snapshot
      data:
        entity_id: camera.door_hb
        filename: "/config/www/cam_captures/doorbell.jpg"
    - service_template: script.turn_on
      data_template:
        entity_id: >
          {% if states('input_boolean.doorbell_mute')=='off' %}script.doorbell_ring
          {%else%}script.noop
          {%endif%}
    - service: notify.telegram_family
      data:
        title: Doorbell photo
        message: "\U0001f514 Внимание! Кто-то звонит в дверь!"
        data:
          photo:
          - file: /config/www/cam_captures/doorbell.jpg
            caption: "\U0001f514 Внимание! Кто-то звонит в дверь! {{states('sensor.time')}} {{states('sensor.date')}}"

# binary_sensor.motion_sensor_158d0001d5995e friendly_name: Motion Mid Door HB
# binary_sensor.motion_sensor_158d0001e05856 friendly_name: Motion Entrance HB
# binary_sensor.motion_sensor_158d0002b482e9 friendly_name: Motion Fridge HB
# binary_sensor.motion_sensor_158d0001ae9f61 friendly_name: Motion HS
# binary_sensor.motion_sensor_158d0002b4729d friendly_name: Motion K
# binary_sensor.motion_sensor_158d0002b48381 friendly_name: Motion 2 K
# binary_sensor.motion_sensor_158d0001e53cda friendly_name: Motion MB
# binary_sensor.motion_sensor_158d000236bb94 friendly_name: Motion V
# binary_sensor.motion_sensor_158d0001aea602 friendly_name: Motion St
# binary_sensor.motion_sensor_158d000236bc6d friendly_name: Motion B
# binary_sensor.motion_sensor_158d0001e54280 friendly_name: Motion T
# binary_sensor.motion_sensor_158d000224f89f friendly_name: Motion S


#    - service: notify.telegram_sandra
#      data:
#        title: Doorbell photo
#        message: "\U0001f514 Внимание! Кто-то звонит в дверь!"
#        data:
#          photo:
#          - file: /config/www/cam_captures/doorbell.jpg
#            caption: "\U0001f514 Внимание! Кто-то звонит в дверь! {{states('sensor.time')}} {{states('sensor.date')}}"
#    - service: notify.telegram_vova
#      data:
#        title: Doorbell photo
#        message: "\U0001f514 Внимание! Кто-то звонит в дверь!"
#        data:
#          photo:
#          - file: /config/www/cam_captures/doorbell.jpg
#            caption: "\U0001f514 Внимание! Кто-то звонит в дверь! {{states('sensor.time')}} {{states('sensor.date')}}"

# ##################################
# Hall big - Domofon Open Button
# ##################################
- alias: hall_big_domofon_button_open
  initial_state: 'on'
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.switch_158d0002f8dd54
      click_type: single
  action:
    - service: script.turn_on
      entity_id: script.domofon_open_door
      
# ##################################
# Hall big - Domofon Auto Open Once
# ##################################
- alias: hall_big_domofon_auto_open_once
  initial_state: 'on'
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.switch_158d0002f8dd54
      click_type: double
  action:
    - service: script.turn_on
      entity_id: script.domofon_auto_open_once_toggle
      
# ##################################
# Hall big - Domofon Auto Open 
# ##################################
- alias: hall_big_domofon_auto_open
  initial_state: 'on'
  trigger:
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.switch_158d0002f8dd54
      click_type: long_click_press
  action:
    - service: script.turn_on
      entity_id: script.domofon_auto_open_toggle
