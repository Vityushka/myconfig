
#{{ 'on' if is_state('sensor.fibaro_system_unknown_type_0701_id_4001_access_control', 23) else 'off' }}

#  - platform: ffmpeg_motion
#    name: Outside motion ffmpeg
#    input: !secret door_cam_720p

  - platform: trend
    sensors:
      bathroom_humidity_rising:
        entity_id: sensor.humidity_158d00020d7c3a
        friendly_name: Humidity B Rising
        sample_duration: 7200
        min_gradient: 0.02
      bathroom_humidity_falling:
        entity_id: sensor.humidity_158d00020d7c3a
        friendly_name: Humidity B Falling
        sample_duration: 7200
        min_gradient: -0.01
      
      pressure_rising_fast_air_valve:
        entity_id: sensor.8266_air_valve_pressure
        friendly_name: Pressure Rising Fast (Air Valve))
        sample_duration: 3600
        max_samples: 10
        min_gradient: 0.00027777777778
      
      pressure_rising_fast:
        entity_id: sensor.pressure_158d000233fb72
        friendly_name: Pressure Rising Fast
        sample_duration: 3600
        max_samples: 10
        min_gradient: 0.00027777777778
      pressure_rising_slow:
        entity_id: sensor.pressure_158d000233fb72
        friendly_name: Pressure Rising Slow
        sample_duration: 3600
        max_samples: 10
        min_gradient: 0.00013888888889
      pressure_falling_fast:
        entity_id: sensor.pressure_158d000233fb72
        friendly_name: Pressure Falling Fast
        sample_duration: 3600
        max_samples: 10
        min_gradient: -0.00027777777778
      pressure_falling_slow:
        entity_id: sensor.pressure_158d000233fb72
        friendly_name: Pressure Falling Slow
        sample_duration: 3600
        max_samples: 10
        min_gradient: -0.00013888888889
      
      temp_falling:
        entity_id: sensor.temperature_158d0001e8995a
        sample_duration: 7200
        min_gradient: -0.0008
        max_samples: 10
        device_class: cold

      temp_rising:
        entity_id: sensor.temperature_158d0001e8995a
        sample_duration: 7200
        min_gradient: 0.0008
        max_samples: 10
        device_class: heat
        

  - platform: template
    sensors:
      update_available:
        friendly_name: HA Update Available
        device_class: occupancy
        value_template: "{{states.sensor.ha_latest_version.state > states.sensor.ha_installed_version.state}}"
      
      # motion_out:
      #   friendly_name: Motion Out
      #   device_class: motion
      #   entity_id: sensor.doorcam_motion_sensor
      #   value_template: "{{ ( (as_timestamp(now()))|int - (as_timestamp(strptime(states.sensor.doorcam_motion_sensor.attributes.date.replace(' +3000',''), '%a, %d %b %Y %H:%M:%S %z')))|int ) | round(0) | int < 20}}"

      # motion_out2:
      #   friendly_name: Motion Out 2
      #   device_class: motion
      #   entity_id: input_boolean.motion_out
      #   value_template: "{{ is_state('input_boolean.motion_out','on') }}"

      doorbell:
        friendly_name: Doorbell
        icon_template: mdi:bell-ring
        delay_off:
          seconds: 5
        value_template: "{{ is_state('binary_sensor.door_window_sensor_158d0003262ba8','off') }}"
  
      doorbell_mute:
        friendly_name: Doorbell Mute
        icon_template: mdi:bell-off
        value_template: "{{ is_state('input_boolean.doorbell_mute','on') }}"
        
      domofon_mute:
        friendly_name: Domofon Mute
        icon_template: mdi:volume-off
        value_template: "{{ is_state('input_boolean.domofon_mute','on') }}"

      domofon_auto_open:
        friendly_name: Domofon Auto Open
        icon_template: mdi:check-all
        value_template: "{{ is_state('input_boolean.domofon_auto_open','on') }}"

      domofon_auto_open_once:
        friendly_name: Domofon Auto Open Once
        icon_template: mdi:check
        value_template: "{{ is_state('input_boolean.domofon_auto_open_once','on') }}"
      
      domofon_ignore:
        friendly_name: Domofon Ignore
        icon_template: mdi:phone-missed
        value_template: "{{ is_state('input_boolean.domofon_ignore','on') }}"

      tv_v_pwr:
        friendly_name: TV status (power))
        icon_template: mdi:television
        entity_id: switch.plug_158d000290a093
        value_template: "{{ state_attr('switch.plug_158d000290a093','load_power') > 10 }}"
          
      tv_v:
        friendly_name: TV V Status
        icon_template: mdi:television
        entity_id: binary_sensor.door_window_sensor_158d000236fdc9
        value_template: "{{ is_state('binary_sensor.door_window_sensor_158d000236fdc9','off') }}"

      iconbit_v:
        friendly_name: Iconbit status
        icon_template: mdi:animation-play
        entity_id: switch.plug_158d000290a0bc
        value_template: "{{ state_attr('switch.plug_158d000290a0bc','load_power') > 2 }}"

      breather_v:
        friendly_name: Breather Status
        icon_template: mdi:power
        entity_id: switch.plug_158d000344998e
        value_template: "{{ state_attr('switch.plug_158d000344998e','load_power') > 5 }}"

      hood_k:
        friendly_name: Hood Status
        icon_template: mdi:fan
        entity_id: switch.d1_hood_fan1, switch.d1_hood_fan2, switch.d1_hood_fan3
        value_template: "{{ is_state('switch.d1_hood_fan1','on') or is_state('switch.d1_hood_fan2','on') or is_state('switch.d1_hood_fan3','on') }}"
      
      hood_lights_k:
        friendly_name: Hood Lights Status
        icon_template: mdi:spotlight-beam
        entity_id: switch.plug_158d000232481a
        value_template: "{{ state_attr('switch.plug_158d000232481a','load_power') >10 and state_attr('switch.plug_158d000232481a','load_power') <30 }}"

      washer_b:
        friendly_name: Washing machine status
        icon_template: mdi:washing-machine
        entity_id: switch.plug_158d0002c3d86e
        delay_off:
          minutes: 2
        value_template: "{{ state_attr('switch.plug_158d0002c3d86e','load_power') > 10 }}"
      
      kettle_k:
        friendly_name: Kettle status
        icon_template: mdi:kettle
        entity_id: switch.plug_158d00028c9875
        value_template: "{{ state_attr('switch.plug_158d00028c9875','load_power') > 10 }}"
      
      tv_k_pwr:
        friendly_name: TV K Status (power)
        icon_template: mdi:television-box
        entity_id: switch.plug_158d0001e85086
        value_template: "{{ state_attr('switch.plug_158d0001e85086','load_power')> 5 }}"
      
      tv_k:
        friendly_name: TV K Status
        icon_template: mdi:television-box
        entity_id: binary_sensor.door_window_sensor_158d0002a1a47a
        value_template: "{{ is_state('binary_sensor.door_window_sensor_158d0002a1a47a','off') }}"

      microwave_k:
        friendly_name: Microwave status
        icon_template: mdi:microwave
        entity_id: switch.plug_158d00028a54e4
        value_template: "{{ state_attr('switch.plug_158d00028a54e4','load_power') > 10 }}"

      ippon_hb_status:
        friendly_name: Ippon 1050 Status HB
        value_template: >
          {% if states('sensor.ippon_hb_status_data') == none or is_state('sensor.ippon_hb_status_data','unknown') or is_state('sensor.ippon_hb_status_data','unavailable') %}
          false
          {% else %}
          true
          {% endif %}
        icon_template: mdi:battery
        device_class: power
      
      ippon_mb_status:
        friendly_name: Ippon 650 Status MB
        value_template: >
          {% if states('sensor.ippon_mb_status_data') == none or is_state('sensor.ippon_mb_status_data.state','unknown') or is_state('sensor.ippon_mb_status_data','unavailable') %}
          false
          {% else %}
          true
          {% endif %}
        icon_template: mdi:battery
        device_class: power

      family_home:
        friendly_name: Family Home
        device_class: presence
        value_template: >
          {% if is_state('person.dima','home') or is_state('person.sandra','home') or is_state('person.vova','home') or is_state('person.sasha','home') %}
          true
          {% else %}
          false
          {% endif %}
          
      motion_hb:
        friendly_name: Motion HB
        device_class: motion
        icon_template: mdi:walk
        value_template: "{{ is_state('binary_sensor.motion_sensor_158d0002b482e9', 'on') or is_state('binary_sensor.motion_sensor_158d0001e05856', 'on') }}"
      
      motion_k:
        friendly_name: Motion K
        device_class: motion
        icon_template: mdi:walk
        value_template: "{{ is_state('binary_sensor.motion_sensor_158d0002b4729d', 'on') or is_state('binary_sensor.motion_sensor_158d0002b48381', 'on') }}"
      
      bottom_lock:
        friendly_name: Bottom Lock
        device_class: lock
        value_template: "{{is_state('binary_sensor.door_window_sensor_158d0002a1a4b2','on')}}"
        delay_off:
          seconds: 2
        #delay_on:
        #  seconds: 2
        icon_template: >
            {% if is_state('binary_sensor.door_window_sensor_158d0002a1a4b2','on') %}
            mdi:lock-open
            {% else %}
            mdi:lock
            {% endif %}
      upper_lock:
        friendly_name: Upper Lock
        device_class: lock
        value_template: "{{is_state('binary_sensor.door_window_sensor_158d0002b7c2c8','on')}}"
        delay_off:
          seconds: 2
        icon_template: >
          {% if is_state('binary_sensor.door_window_sensor_158d0002b7c2c8','on') %}
          mdi:lock-open-outline
          {% else %}
          mdi:lock-outline
          {% endif %}